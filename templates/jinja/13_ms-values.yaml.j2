{% if standalone.enabled is defined and not standalone.enabled %}

{# ============================================================================
   ms-values.yaml.j2
   
   Comprehensive modelservice values template matching the official helm chart.
   See: https://github.com/llm-d/llm-d-modelservice
   ============================================================================ #}

{# Define create flags once at the top for reuse #}
{% set decode_create = (decode.enabled if decode.enabled is defined else (decode.replicas | default(0) | int > 0)) %}
{% set prefill_create = (prefill.enabled if prefill.enabled is defined else (prefill.replicas | default(0) | int > 0)) %}

{# -------------------------------------------------------------------------- #}
{# COMMON / TOP-LEVEL CONFIGURATION                                           #}
{# -------------------------------------------------------------------------- #}
{% if common is defined and common %}
common:
{{ common | toyaml | indent(2) }}
{% endif %}

{% if modelservice is defined and modelservice.enabled is defined %}
enabled: {{ modelservice.enabled | lower }}
{% endif %}

fullnameOverride: {{ model.shortName }}

{% if serviceAccountOverride is defined and serviceAccountOverride %}
serviceAccountOverride: {{ serviceAccountOverride }}
{% endif %}

{% if schedulerName is defined %}
schedulerName: {{ schedulerName }}
{% else %}
schedulerName: default-scheduler
{% endif %}

{# -------------------------------------------------------------------------- #}
{# MODEL ARTIFACTS                                                            #}
{# -------------------------------------------------------------------------- #}
modelArtifacts:
  name: {{ model.name }}
  uri: pvc://{{ storage.modelPvc.name }}/{{ model.path }}
  size: {{ model.size }}
{% if huggingface.secretName is defined and huggingface.secretName %}
  authSecretName: "{{ huggingface.secretName }}"
{% endif %}
{% if modelArtifacts is defined and modelArtifacts.mountPath is defined %}
  mountPath: {{ modelArtifacts.mountPath }}
{% else %}
  mountPath: /model-cache
{% endif %}
  labels:
    llm-d.ai/inferenceServing: "{{ labels.inferenceServing }}"
    llm-d.ai/model: {{ model.shortName }}
{% if modelArtifacts is defined and modelArtifacts.extraLabels is defined %}
{% for key, value in modelArtifacts.extraLabels.items() %}
    {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}

{# -------------------------------------------------------------------------- #}
{# MULTINODE (LeaderWorkerSet)                                                #}
{# -------------------------------------------------------------------------- #}
{% if multinode is defined and multinode.enabled is defined %}
multinode: {{ multinode.enabled | lower }}
{% else %}
multinode: false
{% endif %}

{# -------------------------------------------------------------------------- #}
{# ACCELERATOR CONFIGURATION                                                  #}
{# -------------------------------------------------------------------------- #}
accelerator:
  type: {{ accelerator.type | default('nvidia') }}
{% if accelerator.resources is defined %}
  resources:
{{ accelerator.resources | toyaml | indent(4) }}
{% endif %}
{% if accelerator.env is defined %}
  env:
{{ accelerator.env | toyaml | indent(4) }}
{% endif %}

{# -------------------------------------------------------------------------- #}
{# DYNAMIC RESOURCE ALLOCATION (DRA)                                          #}
{# -------------------------------------------------------------------------- #}
{% if dra is defined and dra.enabled is defined %}
dra:
  enabled: {{ dra.enabled | lower }}
{% if dra.type is defined %}
  type: {{ dra.type }}
{% endif %}
{% if dra.claimTemplates is defined %}
  claimTemplates:
{{ dra.claimTemplates | toyaml | indent(4) }}
{% endif %}
{% endif %}

{# -------------------------------------------------------------------------- #}
{# ROUTING / PROXY CONFIGURATION                                              #}
{# -------------------------------------------------------------------------- #}
routing:
  servicePort: {{ routing.servicePort | default(decode.vllm.servicePort) | default(8000) }}
  proxy:
{% if routing.proxy is defined and routing.proxy.enabled is defined %}
    enabled: {{ routing.proxy.enabled | lower }}
{% else %}
    enabled: true
{% endif %}
    image: "{{ images.routingSidecar.repository }}:{{ images.routingSidecar.tag }}"
{% if routing.proxy is defined and routing.proxy.imagePullPolicy is defined %}
    imagePullPolicy: {{ routing.proxy.imagePullPolicy }}
{% else %}
    imagePullPolicy: Always
{% endif %}
{% if routing.proxy is defined and routing.proxy.targetPort is defined %}
    targetPort: {{ routing.proxy.targetPort }}
{% else %}
    targetPort: {{ decode.vllm.port | default(8200) }}
{% endif %}
    connector: {{ routing.connector | default('nixlv2') }}
    secure: {{ routing.secure | default(false) | lower }}
{% if routing.proxy is defined %}
{% if routing.proxy.prefillerUseTLS is defined %}
    prefillerUseTLS: {{ routing.proxy.prefillerUseTLS | lower }}
{% endif %}
{% if routing.proxy.certPath is defined %}
    certPath: "{{ routing.proxy.certPath }}"
{% endif %}
{% if routing.proxy.zapDevel is defined %}
    zapDevel: {{ routing.proxy.zapDevel | lower }}
{% endif %}
{% if routing.proxy.zapEncoder is defined %}
    zapEncoder: {{ routing.proxy.zapEncoder }}
{% endif %}
{% if routing.proxy.zapLogLevel is defined %}
    zapLogLevel: {{ routing.proxy.zapLogLevel }}
{% endif %}
{% if routing.proxy.zapStacktraceLevel is defined %}
    zapStacktraceLevel: {{ routing.proxy.zapStacktraceLevel }}
{% endif %}
{% if routing.proxy.zapTimeEncoding is defined %}
    zapTimeEncoding: {{ routing.proxy.zapTimeEncoding }}
{% endif %}
{% endif %}
{% if routing.debugLevel is defined %}
    debugLevel: {{ routing.debugLevel }}
{% endif %}

{# -------------------------------------------------------------------------- #}
{# REQUESTER (FMA - Fast Model Actuation)                                     #}
{# -------------------------------------------------------------------------- #}
{% if requester is defined and requester.enable is defined %}
requester:
  enable: {{ requester.enable | lower }}
{% if requester.enable %}
  image: "{{ requester.image }}"
{% if requester.adminPort is defined %}
  adminPort: {{ requester.adminPort }}
{% endif %}
{% if requester.port is defined %}
  port:
{{ requester.port | toyaml | indent(4) }}
{% endif %}
{% if requester.readinessProbe is defined %}
  readinessProbe:
{{ requester.readinessProbe | toyaml | indent(4) }}
{% endif %}
{% if requester.resources is defined %}
  resources:
{{ requester.resources | toyaml | indent(4) }}
{% endif %}
{% endif %}
{% endif %}

{# ========================================================================== #}
{# DECODE SECTION                                                             #}
{# ========================================================================== #}
decode:
  create: {{ decode_create | lower }}
{% if decode_create %}
  replicas: {{ decode.replicas }}

{% if decode.autoscaling is defined %}
  autoscaling:
    enabled: {{ decode.autoscaling.enabled | default(false) | lower }}
{% if decode.autoscaling.minReplicas is defined %}
    minReplicas: {{ decode.autoscaling.minReplicas }}
{% endif %}
{% if decode.autoscaling.maxReplicas is defined %}
    maxReplicas: {{ decode.autoscaling.maxReplicas }}
{% endif %}
{% endif %}

{% if decode.nodeSelector is defined and decode.nodeSelector %}
  nodeSelector:
{{ decode.nodeSelector | toyaml | indent(4) }}
{% endif %}

{% if decode.schedulerName is defined %}
  schedulerName: {{ decode.schedulerName }}
{% endif %}

  acceleratorTypes:
    labelKey: {{ decode.acceleratorType.labelKey }}
    labelValues:
{% if decode.acceleratorType.labelValues is defined %}
{% for value in decode.acceleratorType.labelValues %}
    - {{ value }}
{% endfor %}
{% elif decode.acceleratorType.labelValue is defined %}
    - {{ decode.acceleratorType.labelValue }}
{% endif %}

  parallelism:
    tensor: {{ decode.parallelism.tensor }}
    data: {{ decode.parallelism.data }}
    dataLocal: {{ decode.parallelism.dataLocal }}
    workers: {{ decode.parallelism.workers }}

{% if affinity is defined and affinity.enabled %}
  affinity:
{% if affinity.nodeSelector is defined and affinity.nodeSelector %}
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
{% for key, value in affinity.nodeSelector.items() %}
          - key: {{ key }}
            operator: In
            values:
            - "{{ value }}"
{% endfor %}
{% endif %}
{% if affinity.podAffinity is defined and affinity.podAffinity %}
    podAffinity:
{{ affinity.podAffinity | toyaml | indent(6) }}
{% endif %}
{% if affinity.podAntiAffinity is defined and affinity.podAntiAffinity %}
    podAntiAffinity:
{{ affinity.podAntiAffinity | toyaml | indent(6) }}
{% endif %}
{% endif %}

{% if annotations is defined and annotations.common is defined and annotations.common %}
  annotations:
{% for key, value in annotations.common.items() %}
    {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}

{% if annotations is defined and annotations.decode is defined and annotations.decode.pod is defined and annotations.decode.pod %}
  podAnnotations:
{% for key, value in annotations.decode.pod.items() %}
    {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}

{# LWS / Multinode specific options #}
{% if decode.hostIPC is defined %}
  hostIPC: {{ decode.hostIPC | lower }}
{% endif %}
{% if decode.hostPID is defined %}
  hostPID: {{ decode.hostPID | lower }}
{% endif %}
{% if decode.enableServiceLinks is defined %}
  enableServiceLinks: {{ decode.enableServiceLinks | lower }}
{% endif %}
{% if decode.terminationGracePeriodSeconds is defined %}
  terminationGracePeriodSeconds: {{ decode.terminationGracePeriodSeconds }}
{% endif %}
{% if decode.subGroupPolicy is defined %}
  subGroupPolicy:
{{ decode.subGroupPolicy | toyaml | indent(4) }}
{% endif %}
{% if decode.subGroupExclusiveTopology is defined %}
  subGroupExclusiveTopology: {{ decode.subGroupExclusiveTopology | lower }}
{% endif %}

{# Init containers #}
{% if decode.initContainers is defined and decode.initContainers %}
  initContainers:
{{ decode.initContainers | toyaml | indent(4) }}
{% endif %}

{# Main containers #}
  containers:
  - name: "vllm"
    image: "{{ images.vllm.repository }}:{{ images.vllm.tag }}"
{% if decode.vllm.imagePullPolicy is defined %}
    imagePullPolicy: {{ decode.vllm.imagePullPolicy }}
{% endif %}
    mountModelVolume: {{ decode.mountModelVolume | default(true) | lower }}
    modelCommand: custom
    command:
      - /bin/sh
      - '-c'
    args:
      - |
{{ build_vllm_command('decode') | indent(8, first=True) }}
    env:
      - name: VLLM_NIXL_SIDE_CHANNEL_HOST
        valueFrom:
          fieldRef:
            fieldPath: status.podIP
{% if decode.extraEnvVars is defined and decode.extraEnvVars %}
{% for env in decode.extraEnvVars %}
      - name: {{ env.name }}
{% if env.value is defined %}
        value: "{{ env.value }}"
{% elif env.valueFrom is defined %}
        valueFrom:
{% if env.valueFrom.secretKeyRef is defined %}
          secretKeyRef:
            name: {{ env.valueFrom.secretKeyRef.name }}
            key: {{ env.valueFrom.secretKeyRef.key }}
{% elif env.valueFrom.configMapKeyRef is defined %}
          configMapKeyRef:
            name: {{ env.valueFrom.configMapKeyRef.name }}
            key: {{ env.valueFrom.configMapKeyRef.key }}
{% elif env.valueFrom.fieldRef is defined %}
          fieldRef:
            fieldPath: {{ env.valueFrom.fieldRef.fieldPath }}
{% elif env.valueFrom.resourceFieldRef is defined %}
          resourceFieldRef:
            containerName: {{ env.valueFrom.resourceFieldRef.containerName | default('') }}
            resource: {{ env.valueFrom.resourceFieldRef.resource }}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}
{% if decode.ports is defined and decode.ports %}
    ports:
{{ decode.ports | toyaml | indent(6) }}
{% elif decode.extraContainerConfig is defined and decode.extraContainerConfig.ports is defined %}
    ports:
{% for port in decode.extraContainerConfig.ports %}
      - containerPort: {{ port.containerPort }}
{% if port.name is defined %}
        name: {{ port.name }}
{% endif %}
        protocol: {{ port.protocol | default('TCP') }}
{% endfor %}
{% endif %}
    resources:
      limits:
        memory: {{ decode.resources.limits.memory }}
        cpu: "{{ decode.resources.limits.cpu }}"
{% if decode.resources.limits is defined and decode.resources.limits['nvidia.com/gpu'] is defined %}
        nvidia.com/gpu: "{{ decode.resources.limits['nvidia.com/gpu'] }}"
{% endif %}
{% if decode.resources.limits is defined and decode.resources.limits.claims is defined %}
      claims:
{{ decode.resources.limits.claims | toyaml | indent(8) }}
{% endif %}
      requests:
        memory: {{ decode.resources.requests.memory }}
        cpu: "{{ decode.resources.requests.cpu }}"
{% if decode.resources.requests is defined and decode.resources.requests['nvidia.com/gpu'] is defined %}
        nvidia.com/gpu: "{{ decode.resources.requests['nvidia.com/gpu'] }}"
{% endif %}
    extraConfig:
      startupProbe:
        httpGet:
          path: /health
          port: {{ decode.vllm.servicePort | default(8000) }}
        failureThreshold: {{ decode.probes.startup.failureThreshold | default(60) }}
        initialDelaySeconds: {{ decode.probes.startup.initialDelaySeconds | default(30) }}
        periodSeconds: {{ decode.probes.startup.periodSeconds | default(30) }}
        timeoutSeconds: {{ decode.probes.startup.timeoutSeconds | default(5) }}
      livenessProbe:
        tcpSocket:
          port: {{ decode.vllm.servicePort | default(8000) }}
        failureThreshold: {{ decode.probes.liveness.failureThreshold | default(3) }}
        periodSeconds: {{ decode.probes.liveness.periodSeconds | default(5) }}
      readinessProbe:
        httpGet:
          path: /health
          port: {{ decode.vllm.servicePort | default(8000) }}
        failureThreshold: {{ decode.probes.readiness.failureThreshold | default(3) }}
        periodSeconds: {{ decode.probes.readiness.periodSeconds | default(5) }}
{% if decode.extraContainerConfig is defined and decode.extraContainerConfig %}
{% set extra_config_without_ports = {} %}
{% for k, v in decode.extraContainerConfig.items() if k != 'ports' %}
{% set _ = extra_config_without_ports.update({k: v}) %}
{% endfor %}
{% if extra_config_without_ports %}
{{ extra_config_without_ports | toyaml | indent(6) }}
{% endif %}
{% endif %}
    volumeMounts:
{% for mount in vllmCommon.volumeMounts %}
      - name: {{ mount.name }}
        mountPath: {{ mount.mountPath }}
{% if mount.subPath is defined %}
        subPath: {{ mount.subPath }}
{% endif %}
{% if mount.readOnly is defined %}
        readOnly: {{ mount.readOnly | lower }}
{% endif %}
{% endfor %}
{% if decode.additionalVolumeMounts is defined %}
{% for mount in decode.additionalVolumeMounts %}
      - name: {{ mount.name }}
        mountPath: {{ mount.mountPath }}
{% if mount.subPath is defined %}
        subPath: {{ mount.subPath }}
{% endif %}
{% if mount.readOnly is defined %}
        readOnly: {{ mount.readOnly | lower }}
{% endif %}
{% endfor %}
{% endif %}

  volumes:
{% for volume in vllmCommon.volumes %}
    - name: {{ volume.name }}
{% if volume.type == 'configMap' %}
      configMap:
        name: {{ volume.configMap.name }}
{% if volume.configMap.defaultMode is defined %}
        defaultMode: {{ volume.configMap.defaultMode }}
{% endif %}
{% elif volume.type == 'emptyDir' %}
      emptyDir:
{% if volume.emptyDir.medium is defined %}
        medium: {{ volume.emptyDir.medium }}
{% endif %}
{% if volume.emptyDir.sizeLimit is defined %}
        sizeLimit: {{ volume.emptyDir.sizeLimit }}
{% endif %}
{% elif volume.type == 'persistentVolumeClaim' %}
      persistentVolumeClaim:
        claimName: {{ volume.persistentVolumeClaim.claimName }}
{% elif volume.type == 'secret' %}
      secret:
        secretName: {{ volume.secret.secretName }}
{% if volume.secret.defaultMode is defined %}
        defaultMode: {{ volume.secret.defaultMode }}
{% endif %}
{% elif volume.type == 'hostPath' %}
      hostPath:
        path: {{ volume.hostPath.path }}
{% if volume.hostPath.type is defined %}
        type: {{ volume.hostPath.type }}
{% endif %}
{% endif %}
{% endfor %}
{% if decode.additionalVolumes is defined %}
{% for volume in decode.additionalVolumes %}
    - name: {{ volume.name }}
{% if volume.type == 'configMap' %}
      configMap:
        name: {{ volume.configMap.name }}
{% if volume.configMap.defaultMode is defined %}
        defaultMode: {{ volume.configMap.defaultMode }}
{% endif %}
{% elif volume.type == 'emptyDir' %}
      emptyDir:
{% if volume.emptyDir.medium is defined %}
        medium: {{ volume.emptyDir.medium }}
{% endif %}
{% if volume.emptyDir.sizeLimit is defined %}
        sizeLimit: {{ volume.emptyDir.sizeLimit }}
{% endif %}
{% elif volume.type == 'persistentVolumeClaim' %}
      persistentVolumeClaim:
        claimName: {{ volume.persistentVolumeClaim.claimName }}
{% elif volume.type == 'secret' %}
      secret:
        secretName: {{ volume.secret.secretName }}
{% if volume.secret.defaultMode is defined %}
        defaultMode: {{ volume.secret.defaultMode }}
{% endif %}
{% elif volume.type == 'hostPath' %}
      hostPath:
        path: {{ volume.hostPath.path }}
{% if volume.hostPath.type is defined %}
        type: {{ volume.hostPath.type }}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}

{# Monitoring / PodMonitor #}
{% if decode.monitoring is defined and decode.monitoring.podmonitor is defined %}
  monitoring:
    podmonitor:
      enabled: {{ decode.monitoring.podmonitor.enabled | default(false) | lower }}
{% if decode.monitoring.podmonitor.enabled %}
      portName: "{{ decode.monitoring.podmonitor.portName | default('metrics') }}"
      path: "{{ decode.monitoring.podmonitor.path | default('/metrics') }}"
      interval: "{{ decode.monitoring.podmonitor.interval | default('30s') }}"
{% if decode.monitoring.podmonitor.scrapeTimeout is defined %}
      scrapeTimeout: "{{ decode.monitoring.podmonitor.scrapeTimeout }}"
{% endif %}
{% if decode.monitoring.podmonitor.labels is defined %}
      labels:
{{ decode.monitoring.podmonitor.labels | toyaml | indent(8) }}
{% endif %}
{% if decode.monitoring.podmonitor.annotations is defined %}
      annotations:
{{ decode.monitoring.podmonitor.annotations | toyaml | indent(8) }}
{% endif %}
{% if decode.monitoring.podmonitor.relabelings is defined %}
      relabelings:
{{ decode.monitoring.podmonitor.relabelings | toyaml | indent(8) }}
{% endif %}
{% if decode.monitoring.podmonitor.metricRelabelings is defined %}
      metricRelabelings:
{{ decode.monitoring.podmonitor.metricRelabelings | toyaml | indent(8) }}
{% endif %}
{% endif %}
{% endif %}
{% endif %}

{# ========================================================================== #}
{# PREFILL SECTION                                                            #}
{# ========================================================================== #}
prefill:
  create: {{ prefill_create | lower }}
{% if prefill_create %}
  replicas: {{ prefill.replicas }}

{% if prefill.autoscaling is defined %}
  autoscaling:
    enabled: {{ prefill.autoscaling.enabled | default(false) | lower }}
{% if prefill.autoscaling.minReplicas is defined %}
    minReplicas: {{ prefill.autoscaling.minReplicas }}
{% endif %}
{% if prefill.autoscaling.maxReplicas is defined %}
    maxReplicas: {{ prefill.autoscaling.maxReplicas }}
{% endif %}
{% endif %}

{% if prefill.nodeSelector is defined and prefill.nodeSelector %}
  nodeSelector:
{{ prefill.nodeSelector | toyaml | indent(4) }}
{% endif %}

{% if prefill.schedulerName is defined %}
  schedulerName: {{ prefill.schedulerName }}
{% endif %}

  acceleratorTypes:
    labelKey: {{ prefill.acceleratorType.labelKey }}
    labelValues:
{% if prefill.acceleratorType.labelValues is defined %}
{% for value in prefill.acceleratorType.labelValues %}
    - {{ value }}
{% endfor %}
{% elif prefill.acceleratorType.labelValue is defined %}
    - {{ prefill.acceleratorType.labelValue }}
{% endif %}

  parallelism:
    tensor: {{ prefill.parallelism.tensor }}
    data: {{ prefill.parallelism.data }}
    dataLocal: {{ prefill.parallelism.dataLocal }}
    workers: {{ prefill.parallelism.workers }}

{% if affinity is defined and affinity.enabled %}
  affinity:
{% if affinity.nodeSelector is defined and affinity.nodeSelector %}
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
{% for key, value in affinity.nodeSelector.items() %}
          - key: {{ key }}
            operator: In
            values:
            - "{{ value }}"
{% endfor %}
{% endif %}
{% if affinity.podAffinity is defined and affinity.podAffinity %}
    podAffinity:
{{ affinity.podAffinity | toyaml | indent(6) }}
{% endif %}
{% if affinity.podAntiAffinity is defined and affinity.podAntiAffinity %}
    podAntiAffinity:
{{ affinity.podAntiAffinity | toyaml | indent(6) }}
{% endif %}
{% endif %}

{% if annotations is defined and annotations.common is defined and annotations.common %}
  annotations:
{% for key, value in annotations.common.items() %}
    {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}

{% if annotations is defined and annotations.prefill is defined and annotations.prefill.pod is defined and annotations.prefill.pod %}
  podAnnotations:
{% for key, value in annotations.prefill.pod.items() %}
    {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}

{# LWS / Multinode specific options #}
{% if prefill.hostIPC is defined %}
  hostIPC: {{ prefill.hostIPC | lower }}
{% endif %}
{% if prefill.hostPID is defined %}
  hostPID: {{ prefill.hostPID | lower }}
{% endif %}
{% if prefill.enableServiceLinks is defined %}
  enableServiceLinks: {{ prefill.enableServiceLinks | lower }}
{% endif %}
{% if prefill.terminationGracePeriodSeconds is defined %}
  terminationGracePeriodSeconds: {{ prefill.terminationGracePeriodSeconds }}
{% endif %}
{% if prefill.subGroupPolicy is defined %}
  subGroupPolicy:
{{ prefill.subGroupPolicy | toyaml | indent(4) }}
{% endif %}
{% if prefill.subGroupExclusiveTopology is defined %}
  subGroupExclusiveTopology: {{ prefill.subGroupExclusiveTopology | lower }}
{% endif %}

{# Init containers #}
{% if prefill.initContainers is defined and prefill.initContainers %}
  initContainers:
{{ prefill.initContainers | toyaml | indent(4) }}
{% endif %}

{# Main containers #}
  containers:
  - name: "vllm"
    image: "{{ images.vllm.repository }}:{{ images.vllm.tag }}"
{% if prefill.vllm is defined and prefill.vllm.imagePullPolicy is defined %}
    imagePullPolicy: {{ prefill.vllm.imagePullPolicy }}
{% endif %}
    mountModelVolume: {{ prefill.mountModelVolume | default(true) | lower }}
    modelCommand: vllmServe
    args:
      - |
{{ build_vllm_command('prefill') | indent(8, first=True) }}
    env:
      - name: VLLM_IS_PREFILL
        value: "1"
      - name: VLLM_NIXL_SIDE_CHANNEL_HOST
        valueFrom:
          fieldRef:
            fieldPath: status.podIP
{% if prefill.extraEnvVars is defined and prefill.extraEnvVars %}
{% for env in prefill.extraEnvVars %}
      - name: {{ env.name }}
{% if env.value is defined %}
        value: "{{ env.value }}"
{% elif env.valueFrom is defined %}
        valueFrom:
{% if env.valueFrom.secretKeyRef is defined %}
          secretKeyRef:
            name: {{ env.valueFrom.secretKeyRef.name }}
            key: {{ env.valueFrom.secretKeyRef.key }}
{% elif env.valueFrom.configMapKeyRef is defined %}
          configMapKeyRef:
            name: {{ env.valueFrom.configMapKeyRef.name }}
            key: {{ env.valueFrom.configMapKeyRef.key }}
{% elif env.valueFrom.fieldRef is defined %}
          fieldRef:
            fieldPath: {{ env.valueFrom.fieldRef.fieldPath }}
{% elif env.valueFrom.resourceFieldRef is defined %}
          resourceFieldRef:
            containerName: {{ env.valueFrom.resourceFieldRef.containerName | default('') }}
            resource: {{ env.valueFrom.resourceFieldRef.resource }}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}
{% if prefill.ports is defined and prefill.ports %}
    ports:
{{ prefill.ports | toyaml | indent(6) }}
{% elif prefill.extraContainerConfig is defined and prefill.extraContainerConfig.ports is defined %}
    ports:
{% for port in prefill.extraContainerConfig.ports %}
      - containerPort: {{ port.containerPort }}
{% if port.name is defined %}
        name: {{ port.name }}
{% endif %}
        protocol: {{ port.protocol | default('TCP') }}
{% endfor %}
{% endif %}
    resources:
      limits:
        memory: {{ prefill.resources.limits.memory }}
        cpu: "{{ prefill.resources.limits.cpu }}"
{% if prefill.resources.limits is defined and prefill.resources.limits['nvidia.com/gpu'] is defined %}
        nvidia.com/gpu: "{{ prefill.resources.limits['nvidia.com/gpu'] }}"
{% endif %}
{% if prefill.resources.limits is defined and prefill.resources.limits.claims is defined %}
      claims:
{{ prefill.resources.limits.claims | toyaml | indent(8) }}
{% endif %}
      requests:
        memory: {{ prefill.resources.requests.memory }}
        cpu: "{{ prefill.resources.requests.cpu }}"
{% if prefill.resources.requests is defined and prefill.resources.requests['nvidia.com/gpu'] is defined %}
        nvidia.com/gpu: "{{ prefill.resources.requests['nvidia.com/gpu'] }}"
{% endif %}
    extraConfig:
      startupProbe:
        httpGet:
          path: /health
          port: {{ (prefill.vllm.servicePort if prefill.vllm is defined and prefill.vllm.servicePort is defined else decode.vllm.servicePort) | default(8000) }}
        failureThreshold: {{ prefill.probes.startup.failureThreshold | default(60) }}
        initialDelaySeconds: {{ prefill.probes.startup.initialDelaySeconds | default(30) }}
        periodSeconds: {{ prefill.probes.startup.periodSeconds | default(30) }}
        timeoutSeconds: {{ prefill.probes.startup.timeoutSeconds | default(5) }}
      livenessProbe:
        tcpSocket:
          port: {{ (prefill.vllm.servicePort if prefill.vllm is defined and prefill.vllm.servicePort is defined else decode.vllm.servicePort) | default(8000) }}
        failureThreshold: {{ prefill.probes.liveness.failureThreshold | default(3) }}
        periodSeconds: {{ prefill.probes.liveness.periodSeconds | default(5) }}
      readinessProbe:
        httpGet:
          path: /health
          port: {{ (prefill.vllm.servicePort if prefill.vllm is defined and prefill.vllm.servicePort is defined else decode.vllm.servicePort) | default(8000) }}
        failureThreshold: {{ prefill.probes.readiness.failureThreshold | default(3) }}
        periodSeconds: {{ prefill.probes.readiness.periodSeconds | default(5) }}
{% if prefill.extraContainerConfig is defined and prefill.extraContainerConfig %}
{% set extra_config_without_ports = {} %}
{% for k, v in prefill.extraContainerConfig.items() if k != 'ports' %}
{% set _ = extra_config_without_ports.update({k: v}) %}
{% endfor %}
{% if extra_config_without_ports %}
{{ extra_config_without_ports | toyaml | indent(6) }}
{% endif %}
{% endif %}
    volumeMounts:
{% for mount in vllmCommon.volumeMounts %}
      - name: {{ mount.name }}
        mountPath: {{ mount.mountPath }}
{% if mount.subPath is defined %}
        subPath: {{ mount.subPath }}
{% endif %}
{% if mount.readOnly is defined %}
        readOnly: {{ mount.readOnly | lower }}
{% endif %}
{% endfor %}
{% if prefill.additionalVolumeMounts is defined %}
{% for mount in prefill.additionalVolumeMounts %}
      - name: {{ mount.name }}
        mountPath: {{ mount.mountPath }}
{% if mount.subPath is defined %}
        subPath: {{ mount.subPath }}
{% endif %}
{% if mount.readOnly is defined %}
        readOnly: {{ mount.readOnly | lower }}
{% endif %}
{% endfor %}
{% endif %}

  volumes:
{% for volume in vllmCommon.volumes %}
    - name: {{ volume.name }}
{% if volume.type == 'configMap' %}
      configMap:
        name: {{ volume.configMap.name }}
{% if volume.configMap.defaultMode is defined %}
        defaultMode: {{ volume.configMap.defaultMode }}
{% endif %}
{% elif volume.type == 'emptyDir' %}
      emptyDir:
{% if volume.emptyDir.medium is defined %}
        medium: {{ volume.emptyDir.medium }}
{% endif %}
{% if volume.emptyDir.sizeLimit is defined %}
        sizeLimit: {{ volume.emptyDir.sizeLimit }}
{% endif %}
{% elif volume.type == 'persistentVolumeClaim' %}
      persistentVolumeClaim:
        claimName: {{ volume.persistentVolumeClaim.claimName }}
{% elif volume.type == 'secret' %}
      secret:
        secretName: {{ volume.secret.secretName }}
{% if volume.secret.defaultMode is defined %}
        defaultMode: {{ volume.secret.defaultMode }}
{% endif %}
{% elif volume.type == 'hostPath' %}
      hostPath:
        path: {{ volume.hostPath.path }}
{% if volume.hostPath.type is defined %}
        type: {{ volume.hostPath.type }}
{% endif %}
{% endif %}
{% endfor %}
{% if prefill.additionalVolumes is defined %}
{% for volume in prefill.additionalVolumes %}
    - name: {{ volume.name }}
{% if volume.type == 'configMap' %}
      configMap:
        name: {{ volume.configMap.name }}
{% if volume.configMap.defaultMode is defined %}
        defaultMode: {{ volume.configMap.defaultMode }}
{% endif %}
{% elif volume.type == 'emptyDir' %}
      emptyDir:
{% if volume.emptyDir.medium is defined %}
        medium: {{ volume.emptyDir.medium }}
{% endif %}
{% if volume.emptyDir.sizeLimit is defined %}
        sizeLimit: {{ volume.emptyDir.sizeLimit }}
{% endif %}
{% elif volume.type == 'persistentVolumeClaim' %}
      persistentVolumeClaim:
        claimName: {{ volume.persistentVolumeClaim.claimName }}
{% elif volume.type == 'secret' %}
      secret:
        secretName: {{ volume.secret.secretName }}
{% if volume.secret.defaultMode is defined %}
        defaultMode: {{ volume.secret.defaultMode }}
{% endif %}
{% elif volume.type == 'hostPath' %}
      hostPath:
        path: {{ volume.hostPath.path }}
{% if volume.hostPath.type is defined %}
        type: {{ volume.hostPath.type }}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}

{# Monitoring / PodMonitor #}
{% if prefill.monitoring is defined and prefill.monitoring.podmonitor is defined %}
  monitoring:
    podmonitor:
      enabled: {{ prefill.monitoring.podmonitor.enabled | default(false) | lower }}
{% if prefill.monitoring.podmonitor.enabled %}
      portName: "{{ prefill.monitoring.podmonitor.portName | default('metrics') }}"
      path: "{{ prefill.monitoring.podmonitor.path | default('/metrics') }}"
      interval: "{{ prefill.monitoring.podmonitor.interval | default('30s') }}"
{% if prefill.monitoring.podmonitor.scrapeTimeout is defined %}
      scrapeTimeout: "{{ prefill.monitoring.podmonitor.scrapeTimeout }}"
{% endif %}
{% if prefill.monitoring.podmonitor.labels is defined %}
      labels:
{{ prefill.monitoring.podmonitor.labels | toyaml | indent(8) }}
{% endif %}
{% if prefill.monitoring.podmonitor.annotations is defined %}
      annotations:
{{ prefill.monitoring.podmonitor.annotations | toyaml | indent(8) }}
{% endif %}
{% if prefill.monitoring.podmonitor.relabelings is defined %}
      relabelings:
{{ prefill.monitoring.podmonitor.relabelings | toyaml | indent(8) }}
{% endif %}
{% if prefill.monitoring.podmonitor.metricRelabelings is defined %}
      metricRelabelings:
{{ prefill.monitoring.podmonitor.metricRelabelings | toyaml | indent(8) }}
{% endif %}
{% endif %}
{% endif %}
{% endif %}

{# -------------------------------------------------------------------------- #}
{# EXTRA OBJECTS                                                              #}
{# -------------------------------------------------------------------------- #}
{% if extraObjects is defined and extraObjects %}
extraObjects:
{{ extraObjects | toyaml | indent(2) }}
{% endif %}

{% endif %} 