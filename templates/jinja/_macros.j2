{# ============================================================================
   MACROS - Reusable template functions
   ============================================================================ #}

{# Macro to build vLLM serve command with templated arguments #}
{% macro build_vllm_command(mode='decode') -%}
{% if mode == 'decode' -%}
{% set config = decode -%}
{% else -%}
{% set config = prefill -%}
{% endif -%}


{# Determine preprocess script to use #}
{% if config.vllm.customPreprocessCommand is defined and config.vllm.customPreprocessCommand is not none -%}
{% set preprocess_script = config.vllm.customPreprocessCommand -%}
{% else -%}
{% set preprocess_script = vllmCommon.preprocessScript -%}
{% endif -%}

{# Determine command to use #}
{% if config.vllm.customCommand is defined and config.vllm.customCommand is not none -%}
{# Custom command provided - combine with preprocess script #}
{{ preprocess_script }}; {{ config.vllm.customCommand }}
{%- else -%}
{# Use default vllm serve command with preprocess script #}
{{ preprocess_script }}; vllm serve {{ model.cacheBase }}/{{ model.path }} \
--host {{ vllmCommon.host }} \
--served-model-name {{ model.name }} \
--port {{ config.vllm.port }} \
--block-size {{ model.blockSize }} \
--max-model-len {{ model.maxModelLen }} \
--tensor-parallel-size {{ config.parallelism.tensor }} \
--gpu-memory-utilization {{ model.gpuMemoryUtilization }} \
--kv-transfer-config "{\"kv_connector\":\"{{ vllmCommon.kvTransfer.connector }}\",\"kv_role\":\"{{ vllmCommon.kvTransfer.role }}\"}"
{%- if vllmCommon.flags.enforceEager %} \
--enforce-eager
{%- endif %}
{%- if vllmCommon.flags.disableLogRequests %} \
--disable-log-requests
{%- endif %}
{%- if vllmCommon.flags.disableUvicornAccessLog %} \
--disable-uvicorn-access-log
{%- endif %}
{%- endif %}
{%- endmacro %}


{# Macro to build standalone vLLM serve command #}
{% macro build_standalone_vllm_command() -%}
{# Determine preprocess script to use #}
{% if standalone.vllm.customPreprocessCommand is defined and standalone.vllm.customPreprocessCommand is not none -%}
{% set preprocess_script = standalone.vllm.customPreprocessCommand -%}
{% else -%}
{% set preprocess_script = standalone.vllm.preprocessCommand | default('/bin/true') -%}
{% endif -%}

{# Determine command to use #}
{% if standalone.vllm.customCommand is defined and standalone.vllm.customCommand is not none -%}
{# Custom command provided - combine with preprocess script #}
{{ preprocess_script }} ; {{ standalone.vllm.customCommand }}
{%- else -%}
{# Use default vllm serve command with preprocess script #}
{{ preprocess_script }} ;
 vllm serve {{ model.name }} \
  --no-enable-prefix-caching \
  --load-format {{ standalone.vllm.loadFormat | default('auto') }} \
  --port {{ standalone.vllm.port | default(8000) }} \
  --max-model-len {{ model.maxModelLen }} \
  --disable-log-requests \
  --gpu-memory-utilization {{ model.gpuMemoryUtilization }} \
  --tensor-parallel-size {{ standalone.parallelism.tensor | default(decode.parallelism.tensor) }} \
  --model-loader-extra-config "$LLMDBENCH_VLLM_COMMON_MODEL_LOADER_EXTRA_CONFIG"
{%- endif %}
{%- endmacro %}


{# Macro to render volume mounts #}
{% macro render_volume_mounts(mode='decode') -%}
{% if mode == 'decode' -%}
{% set config = decode -%}
{% else -%}
{% set config = prefill -%}
{% endif -%}
{% for mount in vllmCommon.volumeMounts -%}
    - name: {{ mount.name }}
      mountPath: {{ mount.mountPath }}
{% endfor -%}
{% for mount in config.additionalVolumeMounts -%}
    - name: {{ mount.name }}
      mountPath: {{ mount.mountPath }}
{% if mount.subPath is defined -%}
      subPath: {{ mount.subPath }}
{% endif -%}
{% if mount.readOnly is defined -%}
      readOnly: {{ mount.readOnly | lower }}
{% endif -%}
{% endfor -%}
{%- endmacro %}

{# Macro to render volumes #}
{% macro render_volumes(mode='decode') -%}
{% if mode == 'decode' -%}
{% set config = decode -%}
{% else -%}
{% set config = prefill -%}
{% endif -%}
{% for volume in vllmCommon.volumes -%}
  - name: {{ volume.name }}
{% if volume.type == 'configMap' -%}
    configMap:
{% if volume.configMap.name is defined -%}
      name: {{ volume.configMap.name }}
{% endif -%}
{% if volume.configMap.defaultMode is defined -%}
      defaultMode: {{ volume.configMap.defaultMode }}
{% endif -%}
{% elif volume.type == 'emptyDir' -%}
    emptyDir:
{% if volume.emptyDir.medium is defined -%}
      medium: {{ volume.emptyDir.medium }}
{% endif -%}
{% if volume.emptyDir.sizeLimit is defined -%}
      sizeLimit: {{ volume.emptyDir.sizeLimit }}
{% endif -%}
{% elif volume.type == 'persistentVolumeClaim' -%}
    persistentVolumeClaim:
      claimName: {{ volume.persistentVolumeClaim.claimName }}
{% elif volume.type == 'secret' -%}
    secret:
      secretName: {{ volume.secret.secretName }}
{% if volume.secret.defaultMode is defined -%}
      defaultMode: {{ volume.secret.defaultMode }}
{% endif -%}
{% endif -%}
{% endfor -%}
{% for volume in config.additionalVolumes -%}
  - name: {{ volume.name }}
{% if volume.type == 'configMap' -%}
    configMap:
{% if volume.configMap.name is defined -%}
      name: {{ volume.configMap.name }}
{% endif -%}
{% if volume.configMap.defaultMode is defined -%}
      defaultMode: {{ volume.configMap.defaultMode }}
{% endif -%}
{% elif volume.type == 'emptyDir' -%}
    emptyDir:
{% if volume.emptyDir.medium is defined -%}
      medium: {{ volume.emptyDir.medium }}
{% endif -%}
{% if volume.emptyDir.sizeLimit is defined -%}
      sizeLimit: {{ volume.emptyDir.sizeLimit }}
{% endif -%}
{% elif volume.type == 'persistentVolumeClaim' -%}
    persistentVolumeClaim:
      claimName: {{ volume.persistentVolumeClaim.claimName }}
{% elif volume.type == 'secret' -%}
    secret:
      secretName: {{ volume.secret.secretName }}
{% if volume.secret.defaultMode is defined -%}
      defaultMode: {{ volume.secret.defaultMode }}
{% endif -%}
{% endif -%}
{% endfor -%}
{%- endmacro %}
