apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ system["user-overrides"][0].get("inference-engine", {}).get("model", [{}])[0].get("label", "default-model") }}
  labels: {{ system["user-overrides"][0].get("inference-engine", {}).get("labels", {}) }}
  namespace: {{ system["user-overrides"][0].get("inference-engine", {}).get("namespace", "default") }}
spec:
  replicas: {{ system["user-overrides"][0].get("inference-engine", {}).get("replicas", {}).get("standalone", 1) }}
  selector:
    matchLabels:
      app: {{ system["user-overrides"][0].get("inference-engine", {}).get("model", [{}])[0].get("label", "default-model") }}
  template:
    metadata:
      labels: {{ system["user-overrides"][0].get("inference-engine", {}).get("labels", {}) }}
      annotations: {{ system["user-overrides"][0].get("inference-engine", {}).get("annotations", {}) }}
    spec:
      schedulerName: default-scheduler
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: {{ system["user-overrides"][0].get("inference-engine", {}).get("accelerators", {}).get("standalone", {}).get("key", "") }}
                operator: In
                values:
                - {{ system["user-overrides"][0].get("inference-engine", {}).get("accelerators", {}).get("standalone", {}).get("value", "") }}
      containers:
      - name: vllm-standalone-{{ system["user-overrides"][0].get("inference-engine", {}).get("model", [{}])[0].get("label", "default-model") }}
        image: {{ (images["user-overrides"] | selectattr("name", "equalto", "vllm") | list)[0].get("registry", "") }}/{{ (images["user-overrides"] | selectattr("name", "equalto", "vllm") | list)[0].get("repo", "") }}/{{ (images["user-overrides"] | selectattr("name", "equalto", "vllm") | list)[0].get("image", "") }}:{{ (images["user-overrides"] | selectattr("name", "equalto", "vllm") | list)[0].get("tag", "latest") }}
        imagePullPolicy: Always
        command:
        - /bin/bash
        - "-c"
        args: {{ system["user-overrides"][0].get("inference-engine", {}).get("command", {}).get("standalone", []) }}
        env: {{ system["user-overrides"][0].get("inference-engine", {}).get("env", {}).get("standalone", []) }}
        ports:
        - containerPort: {{ system["user-overrides"][0].get("inference-engine", {}).get("ports", {}).get("service", 8000) }}
        startupProbe:
          httpGet:
            path: /health
            port: {{ system["user-overrides"][0].get("inference-engine", {}).get("ports", {}).get("service", 8000) }}
          failureThreshold: 200
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
        livenessProbe:
          tcpSocket:
            port: {{ system["user-overrides"][0].get("inference-engine", {}).get("ports", {}).get("service", 8000) }}
          failureThreshold: 3
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: {{ system["user-overrides"][0].get("inference-engine", {}).get("ports", {}).get("service", 8000) }}
          failureThreshold: 3
          periodSeconds: 5
        resources:
          limits: {{ system["user-overrides"][0].get("inference-engine", {}).get("resources", {}).get("prefill", {}) }}
          requests: {{ system["user-overrides"][0].get("inference-engine", {}).get("resources", {}).get("prefill", {}) }}
        volumeMounts:
        - name: preprocesses
          mountPath: /setup/preprocess
        - name: cache-volume
          mountPath: {{ system["user-overrides"][0].get("inference-engine", {}).get("volumes", [{}])[0].get("mount", "/cache") }}
        - name: {{ system["user-overrides"][0].get("volumes", [{}])[1].get("name", "dshm") }}
          mountPath: {{ system["user-overrides"][0].get("volumes", [{}])[1].get("mount", "/dev/shm") }}
      volumes:
      - name: preprocesses
        configMap:
          name: {{ prepare["user-overrides"].get("files", [{}])[0].get("name", "preprocess-config") }}
          defaultMode: 0500
      - name: cache-volume
        persistentVolumeClaim:
          claimName: {{ system["user-overrides"][0].get("inference-engine", {}).get("volumes", [{}])[0].get("name", "model-storage") }}
      - name: {{ system["user-overrides"][0].get("volumes", [{}])[1].get("name", "dshm") }}
        emptyDir:
          medium: {{ system["user-overrides"][0].get("volumes", [{}])[1].get("type", "Memory") }}
          sizeLimit: {{ system["user-overrides"][0].get("volumes", [{}])[1].get("size", "16Gi") }}

---

apiVersion: v1
kind: Service
metadata:
  name: {{ system["user-overrides"][0].get("inference-engine", {}).get("model", [{}])[0].get("name", "default-model") }}
  namespace: {{ system["user-overrides"][0].get("inference-engine", {}).get("namespace", "default") }}
  labels: {{ system["user-overrides"][0].get("inference-engine", {}).get("labels", {}) }}
spec:
  ports:
  - name: http
    port: 80
    targetPort: 8000
  selector:
    app: {{ system["user-overrides"][0].get("inference-engine", {}).get("model", [{}])[0].get("name", "default-model") }}
  type: ClusterIP
